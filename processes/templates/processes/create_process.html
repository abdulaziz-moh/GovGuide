{% extends "processes/base_process.html" %}
{% load static %}
{% block head %}
    <link rel="stylesheet" href="{% static 'processes/css/create_p_style.css' %}">
{% endblock %}

{% block main-content %}

<form method="post">
    {% csrf_token %}
    {{process_form.label_tag}}
    <h1>Create Process</h1>
    <div class="create-process">
        <p>
            {{ process_form.title.label_tag }}
            {{ process_form.title }}
            {% if process_form.title.errors %}
                <span style = "color: red">{{ process_form.title.errors }}</span>
            {% endif %}
        </p>

        <p>
            {{ process_form.description.label_tag }}
            {{ process_form.description }}
            {% if process_form.description.errors %}
                <span style = "color: red">{{ process_form.description.errors }}</span>
            {% endif %}
        </p>
    </div>
    

    <h2>Steps</h2>

    {{ formset.management_form }}
    <div id="form-container" class="form-container">
        <div class="vertical-line"></div>
        {% for form in formset %}
        
            <div class="step-form">
                {{ form.step_name }}
                {% if form.step_name.errors %}
                    <span style = "color: red">{{ form.step_name.errors }}</span>
                {% endif %}

                {{ form.description }}
                {% if form.description.errors %}
                    <span style = "color: red">{{ form.description.errors }}</span>
                {% endif %}
                
            </div>
        {% endfor %}
    </div>

    <!-- hidden empty form template -->
    <div id="empty-form" style="display:none;">
        <div class="step-form">
                {{ formset.empty_form.step_name }}
                {% if formset.empty_form.step_name.errors %}
                    <span style = "color: red">{{ formset.empty_form.step_name.errors }}</span>
                {% endif %}

                {{ formset.empty_form.description }}
                {% if formset.empty_form.description.errors %}
                    <span style = "color: red">{{ formset.empty_form.description.errors }}</span>
                {% endif %}         
            
            {% comment %} {{ formset.empty_form.as_p }} {% endcomment %}
        </div>
    </div>
    <div class="buttons">
        <button type="button" id="add-step"><i class="fa-solid fa-plus"></i> Add Step</button>
        <button type="submit" id="save">Save</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const formContainer = document.getElementById('form-container');
    const addButton = document.getElementById('add-step');
    const totalForms = document.getElementById('id_steps-TOTAL_FORMS'); 
    const emptyFormHtml = document.getElementById('empty-form').innerHTML;

    let formCount = parseInt(totalForms.value);

    // Add a null check to ensure the elements are found before adding the event listener
    if (addButton && formContainer && totalForms) {
        addButton.addEventListener('click', function() {
            // Create a temporary div to parse the HTML string
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = emptyFormHtml.replace(/__prefix__/g, formCount);

            // Get the new form element from the temporary div
            const newFormElement = tempDiv.firstElementChild;

            // Append the new form element to the container
            formContainer.appendChild(newFormElement);

            // Scroll the new form into view
            newFormElement.scrollIntoView({ behavior: 'smooth', block: 'start' });

            formCount++;
            totalForms.value = formCount;
        });
    } else {
        console.error("One or more elements not found. Check your HTML IDs.");
    }
});
</script>

{% endblock %}
