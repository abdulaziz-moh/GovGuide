{% extends "processes/base_process.html" %}
{% load static %}
{% block head %}
    <link rel="stylesheet" href="{% static 'processes/css/create_p_style.css' %}">
{% endblock %}

{% block main-content %}

<form method="post">
    {% csrf_token %}
    {{process_form.label_tag}}
    {% if process_form.instance.pk %}
        <h1>Update Process <h1>
    {% else %} 
        <h1>Create Process</h1>
    {% endif %}
    
    <div class="create-process">
        <p>
            {{ process_form.title.label_tag }}
            {{ process_form.title }}
            {% if process_form.title.errors %}
                <span style = "color: red">{{ process_form.title.errors }}</span>
            {% endif %}
        </p>

        <p>
            {{ process_form.description.label_tag }}
            {{ process_form.description }}
            {% if process_form.description.errors %}
                <span style = "color: red">{{ process_form.description.errors }}</span>
            {% endif %}
        </p>
    </div>
    

    <h2>Steps</h2>

    {{ formset.management_form }}
    <div id="form-container" class="form-container">
        <div class="vertical-line"></div>

        {% for form in formset %}
            <div class="step-form">
                {{ form.id }}  {# <-- this is the hidden primary key field, REQUIRED(if it doesn't exist the update doesn't create an id making a formset invalid ) #}
                {{ form.step_name }}
                {% if form.step_name.errors %}
                    <span style = "color: red">{{ form.step_name.errors }}</span>
                {% endif %}

                {{ form.description }}
                {% if form.description.errors %}
                    <span style = "color: red">{{ form.description.errors }}</span>
                {% endif %}
                {{ form.DELETE }}
                <button type="button" class="remove-step"><i class="fa-solid fa-trash-can"></i><p>Remove<p></button>

                
            </div>
        {% endfor %}
    </div>

    <!-- hidden empty form template -->
    <div id="empty-form" style="display:none;">
        <div class="step-form">
                {{ form.id }}  {# <-- this is the hidden primary key field, REQUIRED #}

                {{ formset.empty_form.step_name }}
                {% if formset.empty_form.step_name.errors %}
                    <span style = "color: red">{{ formset.empty_form.step_name.errors }}</span>
                {% endif %}

                {{ formset.empty_form.description }}
                {% if formset.empty_form.description.errors %}
                    <span style = "color: red">{{ formset.empty_form.description.errors }}</span>
                {% endif %}
                {{ formset.empty_form.DELETE }}
                <button type="button" class="remove-step"><i class="fa-solid fa-trash-can"></i><p>Remove<p></button>

 
            {% comment %} {{ formset.empty_form.as_p }} {% endcomment %}
        </div>
    </div>
    <div class="buttons">
        <button type="button" id="add-step"><i class="fa-solid fa-plus"></i> Add Step</button>
        <button type="submit" id="save">Save</button>
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formContainer = document.getElementById('form-container');
    const addButton = document.getElementById('add-step');
    const totalForms = document.getElementById('id_steps-TOTAL_FORMS');
    const emptyFormHtml = document.getElementById('empty-form').innerHTML;

    let formCount = parseInt(totalForms.value);

    // Add new step form
    if (addButton && formContainer && totalForms) {
        addButton.addEventListener('click', function() {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = emptyFormHtml.replace(/__prefix__/g, formCount);

            const newFormElement = tempDiv.firstElementChild;
            formContainer.appendChild(newFormElement);

            newFormElement.scrollIntoView({ behavior: 'smooth', block: 'start' });

            formCount++;
            totalForms.value = formCount;

            attachRemoveHandler(newFormElement);
        });
    }

    // Attach remove behavior
    function attachRemoveHandler(stepDiv) {
        const removeBtn = stepDiv.querySelector('.remove-step');
        const deleteField = stepDiv.querySelector('input[name$="-DELETE"]');

        if (removeBtn && deleteField) {
            removeBtn.addEventListener('click', function() {
                Swal.fire({
                    title: "Are you sure?",
                    text: "This step will be deleted.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        deleteField.checked = true;
                        stepDiv.style.display = 'none';
                    }
                });

            });
        }
    }


    // Attach to already existing forms
    document.querySelectorAll('.step-form').forEach(attachRemoveHandler);
});

</script>

{% endblock %}
